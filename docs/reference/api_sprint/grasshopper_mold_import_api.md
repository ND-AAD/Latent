# Grasshopper Mold Import API

## Overview

The Grasshopper HTTP server provides a POST endpoint to import NURBS molds generated by the desktop application back into Rhino.

This completes the bidirectional loop:
```
Rhino SubD → Desktop analysis → NURBS molds → POST to Grasshopper → Import to Rhino
```

## Endpoint

**URL**: `http://localhost:8888/molds`
**Method**: `POST`
**Content-Type**: `application/json`

## Request Format

```json
{
  "type": "ceramic_mold_set",
  "molds": [
    {
      "name": "mold_1",
      "degree_u": 3,
      "degree_v": 3,
      "count_u": 4,
      "count_v": 4,
      "control_points": [
        [x, y, z],
        ...
      ],
      "weights": [w, ...],
      "knots_u": [u0, u1, ...],
      "knots_v": [v0, v1, ...]
    },
    ...
  ]
}
```

### Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `type` | string | Must be "ceramic_mold_set" |
| `molds` | array | Array of mold objects to import |
| `name` | string | Name for the NURBS surface in Rhino |
| `degree_u` | int | U-direction degree (1-25, typically 3) |
| `degree_v` | int | V-direction degree (1-25, typically 3) |
| `count_u` | int | Number of control points in U direction |
| `count_v` | int | Number of control points in V direction |
| `control_points` | array | Flattened array of [x,y,z] coordinates |
| `weights` | array | Array of weights (positive numbers, typically 1.0) |
| `knots_u` | array | U-direction knot vector |
| `knots_v` | array | V-direction knot vector |

### NURBS Surface Requirements

**Control Points**:
- Total count must equal `count_u * count_v`
- Ordered in row-major format (U varies fastest)
- Each point is [x, y, z] array

**Weights**:
- Must be positive numbers
- Length must equal `count_u * count_v`
- For non-rational surfaces, use all 1.0

**Knot Vectors**:
- Must be non-decreasing
- Length: `count + degree + 1`
- `knots_u` length: `count_u + degree_u + 1`
- `knots_v` length: `count_v + degree_v + 1`

**Rhino Conversion**:
- Rhino uses `order = degree + 1`
- The endpoint handles this conversion automatically

## Response Format

### Success (200 OK)

```json
{
  "status": "success",
  "imported_count": 2,
  "guids": [
    "A1B2C3D4-E5F6-4789-ABCD-EF0123456789",
    "B2C3D4E5-F6A7-4890-BCDE-F01234567890"
  ]
}
```

| Field | Type | Description |
|-------|------|-------------|
| `status` | string | "success" |
| `imported_count` | int | Number of molds successfully imported |
| `guids` | array | Rhino GUIDs of created surfaces |

### Error Responses

**400 Bad Request** - Invalid data type
```json
{
  "error": "Invalid data type"
}
```

**500 Internal Server Error** - Import failed
```json
{
  "error": "Import failed: <error message>"
}
```

## Usage Examples

### Using curl

```bash
curl -X POST http://localhost:8888/molds \
  -H "Content-Type: application/json" \
  -d @test_mold.json
```

### Using Python (requests)

```python
import requests
import json

# Load mold data
with open('test_mold.json', 'r') as f:
    mold_data = json.load(f)

# Send to Grasshopper
response = requests.post(
    'http://localhost:8888/molds',
    json=mold_data,
    headers={'Content-Type': 'application/json'}
)

if response.status_code == 200:
    result = response.json()
    print(f"Imported {result['imported_count']} molds")
    print(f"GUIDs: {result['guids']}")
else:
    print(f"Error: {response.text}")
```

### From Desktop App

```python
from app.bridge.rhino_bridge import RhinoBridge

# Serialize molds (Agent 52 implementation)
mold_data = {
    "type": "ceramic_mold_set",
    "molds": serialize_molds(nurbs_molds)
}

# Send to Grasshopper
bridge = RhinoBridge()
response = bridge.send_molds(mold_data)

if response['status'] == 'success':
    print(f"Imported {response['imported_count']} molds")
```

## Testing

### Unit Tests

```bash
# Run mold data format tests
python tests/test_mold_import.py
```

### Integration Tests

```bash
# Test POST endpoint (requires running Grasshopper server)
python tests/test_grasshopper_post.py
```

### Manual Testing

1. **Start Grasshopper server**:
   - Open Rhino and Grasshopper
   - Load the HTTP server component
   - Set Run = True

2. **Verify server is running**:
   ```bash
   curl http://localhost:8888/status
   ```

3. **Send test molds**:
   ```bash
   curl -X POST http://localhost:8888/molds \
     -H "Content-Type: application/json" \
     -d @tests/test_mold.json
   ```

4. **Check Rhino**:
   - Test molds should appear in Rhino viewport
   - Named "test_mold_1" and "test_mold_2"

## Error Handling

The endpoint includes robust error handling:

1. **Connection validation** - Verifies Content-Length header
2. **JSON parsing** - Catches malformed JSON
3. **Type validation** - Checks for "ceramic_mold_set" type
4. **Surface creation** - Handles NURBS construction errors
5. **Graceful degradation** - Continues importing remaining molds if one fails

## Implementation Details

### NURBS Surface Creation

```python
# Create NurbsSurface
surface = rg.NurbsSurface.Create(
    dimension=3,
    isRational=True,
    orderU=degree_u + 1,  # Rhino uses order = degree + 1
    orderV=degree_v + 1,
    controlPointCountU=count_u,
    controlPointCountV=count_v
)

# Set control points and weights
idx = 0
for i in range(count_u):
    for j in range(count_v):
        x, y, z = points[idx]
        w = weights[idx]
        surface.Points.SetPoint(i, j, x, y, z, w)
        idx += 1

# Set knot vectors
for i, knot in enumerate(knots_u):
    surface.KnotsU[i] = knot
for i, knot in enumerate(knots_v):
    surface.KnotsV[i] = knot
```

### Control Point Ordering

Control points are stored in **row-major order**:
- For a 4×4 grid with `count_u=4`, `count_v=4`:
- Points 0-3: First row (U=0, V=0..3)
- Points 4-7: Second row (U=1, V=0..3)
- Points 8-11: Third row (U=2, V=0..3)
- Points 12-15: Fourth row (U=3, V=0..3)

### Knot Vector Format

For a degree-3 surface with 4 control points:
- Standard clamped: `[0, 0, 0, 0, 1, 1, 1, 1]`
- Length = 4 + 3 + 1 = 8

## Dependencies

**Grasshopper Server**:
- `Rhino.Geometry` (RhinoCommon)
- `rhinoscriptsyntax` (for document operations)
- `http.server` (Python standard library)
- `json` (Python standard library)

**Desktop App**:
- `requests` (for HTTP POST)
- Agent 52 NURBS serialization

## Integration Notes

**For Agent 54 (Desktop POST client)**:
- Use the format specified in this document
- Handle 200/400/500 response codes
- Display imported GUIDs to user
- Provide retry logic for connection errors

**For Agent 52 (NURBS serialization)**:
- Ensure control points are row-major ordered
- Use degree, not order
- Include all required fields
- Validate knot vector lengths

## References

- **Specification**: `subdivision_surface_ceramic_mold_generation_v5.md` §8.2
- **Implementation**: `rhino/grasshopper_http_server_control_cage.py`
- **Tests**: `tests/test_mold_import.py`, `tests/test_grasshopper_post.py`
- **Test Data**: `tests/test_mold.json`
